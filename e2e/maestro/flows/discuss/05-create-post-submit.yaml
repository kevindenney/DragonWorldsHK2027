# Discuss Create Post Submit Test
# Tests the full post creation flow including actual submission
#
# Verifies:
# - Post is actually created and submitted to the backend
# - Post appears in the feed after submission
# - Timestamp in title allows identification of test posts
#
# NOTE: This test creates real posts in the database.
# Test posts are tagged with "[MAESTRO-TEST]" prefix for easy identification.

appId: com.denneyke.dragonworldshk2027
name: Discuss - Create Post Submit

---

# =====================
# AUTHENTICATION
# =====================

- launchApp:
    clearState: true

- extendedWaitUntil:
    visible: "Welcome to"
    timeout: 10000

- tapOn: "Continue with Email"

- extendedWaitUntil:
    visible: "Join the Fleet"
    timeout: 5000

- tapOn:
    id: "register-displayname"
- inputText: "Post Submit Test"

- tapOn:
    id: "register-email"
- inputText: "postsubmit${Date.now()}@maestro.test"

- hideKeyboard
- waitForAnimationToEnd

- tapOn:
    id: "register-password-password-toggle"
- waitForAnimationToEnd
- tapOn:
    id: "register-password"
- eraseText: 100
- inputText: "TestPass123!"

- hideKeyboard
- waitForAnimationToEnd

- tapOn:
    id: "register-confirm-password-password-toggle"
- waitForAnimationToEnd
- tapOn:
    id: "register-confirm-password"
- eraseText: 100
- inputText: "TestPass123!"

- hideKeyboard
- waitForAnimationToEnd

- tapOn:
    id: "register-submit"

# Wait for account creation
- extendedWaitUntil:
    visible: "Schedule"
    timeout: 60000

# Dismiss tooltips
- tapOn:
    text: "Next"
    optional: true
- waitForAnimationToEnd
- tapOn:
    text: "Next"
    optional: true
- waitForAnimationToEnd
- tapOn:
    text: "Got it"
    optional: true
- waitForAnimationToEnd
- tapOn:
    text: "Done"
    optional: true
- waitForAnimationToEnd

# =====================
# NAVIGATE TO DISCUSS
# =====================

- tapOn:
    id: "tab-more"

- extendedWaitUntil:
    visible: "More"
    timeout: 5000

- tapOn:
    id: "more-menu-discuss"

- extendedWaitUntil:
    visible: "Dragon Worlds"
    timeout: 10000

# =====================
# NAVIGATE TO DRAGON WORLDS & JOIN
# =====================

- tapOn: "Dragon Worlds"
- waitForAnimationToEnd

# Wait for community to load
- extendedWaitUntil:
    visible: "2027 HK Dragon Worlds"
    timeout: 10000
    optional: true

# Join community if not already a member
- tapOn:
    id: "community-join-button"
    optional: true

- waitForAnimationToEnd

# Brief pause for join to complete
- swipe:
    direction: DOWN
    duration: 100
- swipe:
    direction: UP
    duration: 100

# Wait for membership status to update
- extendedWaitUntil:
    visible: "Joined"
    timeout: 5000
    optional: true

# =====================
# TEST: CREATE AND SUBMIT POST
# =====================

# Tap the new post button
- tapOn:
    id: "discuss-new-post-button"

# Wait for modal to open
- extendedWaitUntil:
    visible: "New Post"
    timeout: 5000

# Verify modal is visible
- assertVisible:
    id: "create-post-modal"

# =====================
# TEST: SELECT POST TYPE - DISCUSSION
# =====================

# Tap on Discussion type to ensure it's selected
- tapOn:
    id: "create-post-type-discussion"

- waitForAnimationToEnd

# =====================
# TEST: ENTER TITLE WITH TIMESTAMP
# =====================

# Tap and enter title with [MAESTRO-TEST] tag for identification
- tapOn:
    id: "create-post-title-input"

- inputText: "[MAESTRO-TEST] Discussion Post ${Date.now()}"

- hideKeyboard

# =====================
# TEST: ENTER BODY CONTENT
# =====================

- tapOn:
    id: "create-post-body-input"

- inputText: "This is an automated test post created by Maestro E2E testing. The timestamp in the title allows identification and cleanup of test data. Please disregard this post."

- hideKeyboard

# =====================
# TEST: SUBMIT THE POST
# =====================

# Verify submit button is enabled (title has 5+ chars)
- assertVisible:
    id: "create-post-submit-button"

# Take screenshot before submission
- takeScreenshot: "before_submit"

# Tap submit button
- tapOn:
    id: "create-post-submit-button"

# Wait for submission to complete and modal to close
- waitForAnimationToEnd

# Wait for modal to be dismissed (timeout longer for API call)
- extendedWaitUntil:
    notVisible: "New Post"
    timeout: 10000
    optional: true

# =====================
# TEST: VERIFY POST APPEARS IN FEED
# =====================

# Wait for feed to refresh
- waitForAnimationToEnd

# Pull to refresh to ensure latest posts are shown
- swipe:
    direction: DOWN
    duration: 500

- waitForAnimationToEnd

# Take screenshot of feed after post creation
- takeScreenshot: "after_submit"

# Verify the test post appears in the feed
# Note: The exact text match may vary - look for MAESTRO-TEST tag
- assertVisible:
    text: "[MAESTRO-TEST]"
    optional: true

# Alternative: verify Discussion badge is visible (post was created with type general)
- assertVisible:
    text: "Discussion"
    optional: true

# =====================
# TEST: MODAL DISMISS WITHOUT POSTING
# =====================

# Open create post modal again
- tapOn:
    id: "discuss-new-post-button"
    optional: true

- extendedWaitUntil:
    visible: "New Post"
    timeout: 5000
    optional: true

# Verify form is cleared (no previous input)
- assertVisible:
    id: "create-post-title-input"
    optional: true

# Close without posting
- tapOn:
    id: "create-post-close-button"
    optional: true

- waitForAnimationToEnd

# Verify modal is closed
- assertNotVisible:
    id: "create-post-modal"
    optional: true

# Verify we're back on the Discuss screen
- assertVisible: "Dragon Worlds"

# Test complete - create post submit verified
