rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
             request.auth.token.role == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && 
             request.auth.token.role in roles;
    }
    
    function isOwnerOrAdmin(userId) {
      return isOwner(userId) || hasAnyRole(['admin', 'superadmin']);
    }
    
    function validateUserData() {
      let requiredFields = ['uid', 'email', 'displayName', 'role', 'status'];
      let allowedRoles = ['user', 'admin', 'superadmin'];
      let allowedStatuses = ['active', 'inactive', 'suspended', 'pending_verification'];
      
      return requiredFields.toSet().isSubsetOf(resource.data.keys().toSet()) &&
             resource.data.role in allowedRoles &&
             resource.data.status in allowedStatuses &&
             resource.data.uid is string &&
             resource.data.email is string &&
             resource.data.displayName is string;
    }
    
    function validateEmailChange() {
      // Email can only be changed by the user themselves
      return !('email' in resource.data) || 
             resource.data.email == request.auth.token.email;
    }
    
    function validateRoleChange() {
      // Only admins can change roles, and only superadmin can assign admin roles
      return !('role' in resource.data) ||
             (hasRole('superadmin')) ||
             (hasRole('admin') && resource.data.role == 'user');
    }

    // Users collection
    match /users/{userId} {
      // Read: Users can read their own data, admins can read any user
      allow read: if isOwnerOrAdmin(userId);
      
      // Create: Users can create their own profile, admins can create any
      allow create: if (isOwner(userId) || hasAnyRole(['admin', 'superadmin'])) &&
                       validateUserData() &&
                       resource.data.uid == userId;
      
      // Update: Users can update their own data (except role), admins can update any
      allow update: if isOwnerOrAdmin(userId) &&
                       validateUserData() &&
                       validateEmailChange() &&
                       validateRoleChange() &&
                       resource.data.uid == userId;
      
      // Delete: Only admins can delete (soft delete recommended)
      allow delete: if hasAnyRole(['admin', 'superadmin']);
    }

    // User sessions collection
    match /user_sessions/{sessionId} {
      allow read, write: if isAuthenticated() && 
                            resource.data.uid == request.auth.uid;
      allow read, write: if hasAnyRole(['admin', 'superadmin']);
    }

    // User activity collection  
    match /user_activity/{activityId} {
      allow read: if isAuthenticated() && 
                     resource.data.uid == request.auth.uid;
      allow read: if hasAnyRole(['admin', 'superadmin']);
      allow create: if isAuthenticated() && 
                       resource.data.uid == request.auth.uid;
    }

    // User notifications collection
    match /user_notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                     resource.data.uid == request.auth.uid;
      allow read, write: if hasAnyRole(['admin', 'superadmin']);
      allow update: if isAuthenticated() && 
                       resource.data.uid == request.auth.uid &&
                       // Only allow updating read status and delivered status
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['readAt', 'deliveredAt', 'status']);
    }

    // Races collection
    match /races/{raceId} {
      // Anyone can read race information
      allow read: if true;
      
      // Only admins can create/update/delete races
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Results collection
    match /results/{resultId} {
      // Anyone can read results
      allow read: if true;
      
      // Only admins can create/update results
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Teams collection
    match /teams/{teamId} {
      // Anyone can read team information
      allow read: if true;
      
      // Team members can update their own team
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.members;
      
      // Admins can create/update/delete teams
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Events collection
    match /events/{eventId} {
      // Anyone can read events
      allow read: if true;
      
      // Only admins can create/update/delete events
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Notifications collection (system-wide notifications)
    match /notifications/{notificationId} {
      // Anyone can read public notifications
      allow read: if true;
      
      // Only admins can create/update/delete notifications
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Social posts collection
    match /socialPosts/{postId} {
      // Anyone can read social posts
      allow read: if true;
      
      // Authenticated users can create posts
      allow create: if isAuthenticated() && 
                       resource.data.authorId == request.auth.uid;
      
      // Users can update/delete their own posts, admins can moderate any
      allow update, delete: if isAuthenticated() && 
                              (resource.data.authorId == request.auth.uid || 
                               hasAnyRole(['admin', 'superadmin']));
    }

    // Regatta participants collection
    match /regatta_participants/{participantId} {
      // Participants can read their own data, admins can read all
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      hasAnyRole(['admin', 'superadmin']));
      
      // Users can register themselves, admins can register anyone
      allow create: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || 
                        hasAnyRole(['admin', 'superadmin']));
      
      // Users can update their own registration, admins can update any
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || 
                        hasAnyRole(['admin', 'superadmin']));
      
      // Only admins can delete registrations
      allow delete: if hasAnyRole(['admin', 'superadmin']);
    }

    // Weather favorites collection
    match /weather_favorites/{favoriteId} {
      // Users can only access their own weather favorites
      allow read, write: if isAuthenticated() && 
                            resource.data.userId == request.auth.uid;
      
      // Admins can access all weather favorites
      allow read, write: if hasAnyRole(['admin', 'superadmin']);
    }

    // User subscriptions collection
    match /user_subscriptions/{subscriptionId} {
      // Users can read their own subscriptions
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Admins can read all subscriptions
      allow read: if hasAnyRole(['admin', 'superadmin']);
      
      // System can create/update subscriptions (via Cloud Functions)
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Notice board collection (official notices from racingrulesofsailing.org)
    match /notices/{noticeId} {
      // All authenticated users can read notices
      allow read: if isAuthenticated();
      
      // Only Cloud Functions and admins can write notices
      // Cloud Functions are authenticated with admin privileges
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // User notice status collection (read/bookmark status per user)
    match /userNoticeStatus/{statusId} {
      // Users can only read/write their own notice status
      allow read, write: if isAuthenticated() && 
                            resource.data.userId == request.auth.uid;
      
      // Admins can read all notice statuses
      allow read: if hasAnyRole(['admin', 'superadmin']);
      
      // Validate that statusId format is userId_noticeId
      allow create: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       statusId.matches('^' + request.auth.uid + '_.*$');
    }

    // Race data cache collection (for Cloud Function caching)
    match /raceDataCache/{cacheId} {
      // All authenticated users can read cached data
      allow read: if isAuthenticated();
      
      // Only Cloud Functions and admins can write cache data
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Documents collection (official documents from multiple sources)
    match /documents/{documentId} {
      // All authenticated users can read documents
      allow read: if isAuthenticated();
      
      // Only Cloud Functions and admins can write documents
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Document content collection (processed document text and metadata)
    match /document_content/{documentId} {
      // All authenticated users can read document content
      allow read: if isAuthenticated();
      
      // Only Cloud Functions and admins can write document content
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Event-specific documents subcollection
    match /events/{eventId}/documents/{documentId} {
      // All authenticated users can read event documents
      allow read: if isAuthenticated();
      
      // Only Cloud Functions and admins can write event documents
      allow write: if hasAnyRole(['admin', 'superadmin']);
    }

    // Activities collection (system activities)
    match /activities/{activityId} {
      // Only admins can read system activities
      allow read: if hasAnyRole(['admin', 'superadmin']);
      
      // System functions can create activities
      allow create: if hasAnyRole(['admin', 'superadmin']);
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}